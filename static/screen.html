<!doctype html>
<html>
    <head>
        <title>SCREEN</title>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="/static/3rd_party/bootstrap-4.3.1-dist/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/static/main.css" />
<style>
</style>
    </head>

    <body>
        <div class="notes-canvas">
            <div class="notes-block">
                <span class="notes">
                </span>
            </div>
            <div class="lyrics-1"></div>
            <div class="time-signal"></div>
        </div>

        <div class="indicators">
            <span class="badge badge-light" data-indicator="ruleset">(no ruleset)</span>
            <span class="badge badge-light" data-indicator="device">(no midi)</span>
            <span class="badge badge-light off" data-indicator="console">console</span>
            <span class="badge badge-light off" data-indicator="ws">ws</span>
        </div>

        <script src="/static/3rd_party/jquery-3.4.1.min.js"></script>
        <script>
$(document).ready(function() {
    var consoleMode = true;

    // Simple auto-reconnect
    // https://stackoverflow.com/questions/22431751/websocket-how-to-automatically-reconnect-after-it-dies/23176223
    var ws = null;
    var connect = function() {
        ws = new WebSocket("ws://" + window.location.host + "/socket");
        ws.onopen = function() {
            $("[data-indicator='ws']").removeClass("off");
        };

        ws.onmessage = function(e) {
            if (e.data) {
                var packet = JSON.parse(e.data);
                if (packet.data.type === 'midi') {
                    if (packet.data.context.pedal) {
                        $(".notes").addClass("pedal");
                    }
                    else {
                        $(".notes").removeClass("pedal");
                    }

                    // $(".notes").text(packet.data.context.notes.join(", "));
                    console.log(packet.data.message);
                    if (packet.data.message.type === "note_on") {
                        noteOn(packet.data.message.note, packet.data.message.note_display, packet.data.message.velocity);
                    }
                    else if (packet.data.message.type === "note_off") {
                        noteOff(packet.data.message.note);
                    }
                    else if (packet.data.message.type === "control_change") {
                        // Play button, turns the console on (visible)
                        if (packet.data.message.control === 117 && packet.data.message.value === 0) {
                            consoleMode = true;
                            reflectConsoleMode();
                        }
                        // Stop button, turns the console off (invisible)
                        else if (packet.data.message.control === 116 && packet.data.message.value === 0) {
                            consoleMode = false;
                            reflectConsoleMode();
                        }
                        // Forward button. Make the ruleset to braincramp
                        else if (packet.data.message.control === 115 && packet.data.message.value === 0) {
                            changeRuleSet("braincramp");
                        }
                        // Backward button. Make the ruleset to cakewalk
                        else if (packet.data.message.control === 114 && packet.data.message.value === 0) {
                            changeRuleSet("cakewalk");
                        }
                    }
                }
                else if (packet.data.type === 'signal') {
                    console.log(packet.data.name);
                    var $signalBlock = $("<div class='signal-block'>" + packet.data.name + "</div>");
                    $(".notes-canvas").append($signalBlock);
                    animateSignal($signalBlock);

                    if (packet.data.name === "led-pattern-1") {
                        $(".lyrics-1").text("腦").removeClass("word2").removeClass("word3").addClass("word1");
                    }
                    if (packet.data.name === "led-pattern-2") {
                        $(".lyrics-1").text("抽").removeClass("word1").removeClass("word3").addClass("word2");
                    }
                    if (packet.data.name === "led-pattern-3") {
                        $(".lyrics-1").text("筋").removeClass("word1").removeClass("word2").addClass("word3");
                    }
                    if (packet.data.name === "led-pattern-4") {
                        $(".lyrics-1").text("").removeClass("word1").removeClass("word2").removeClass("word3");
                    }

                    if (packet.data.name === "reset") {
                    $(".time-signal").text("");
                        $(".lyrics-1").text("").removeClass("word1").removeClass("word2").removeClass("word3");
                    }
                }
                else if (packet.data.type === 'timer') {
                    console.log(packet.data.name);
                    $(".time-signal").text(packet.data.name);

                    if (packet.data.name === "!1.1") {
                        $(".lyrics-1").text("什麼叫做 R & D").removeClass("word1").removeClass("word2").removeClass("word3");
                    }
                    else if (packet.data.name === "!2.1") {
                        $(".lyrics-1").text("寫 code 寫到腦抽筋");
                    }
                    else if (packet.data.name === "!3.1") {
                        $(".lyrics-1").text("什麼叫做小確幸");
                    }
                    else if (packet.data.name === "!4.1") {
                        $(".lyrics-1").text("今天整天沒會議");
                    }
                    else if (packet.data.name === "!5.1") {
                        $(".lyrics-1").text("今天整天沒會議");
                    }
                    else if (packet.data.name === "!6.1") {
                        $(".lyrics-1").text("寫");
                    }
                    else if (packet.data.name === "!6.2") {
                        $(".lyrics-1").text("code");
                    }
                    else if (packet.data.name === "!6.3") {
                        $(".lyrics-1").text("寫");
                    }
                    else if (packet.data.name === "!6.4") {
                        $(".lyrics-1").text("到");
                    }
                    else if (packet.data.name === "!6.5") {
                        $(".lyrics-1").text("");
                    }
                    else if (packet.data.name[packet.data.name.length - 1] === "8" && packet.data.name !== "!6.8") {
                        $(".lyrics-1").text("");
                    }
                }
                else if (packet.data.type === 'status') {
                    console.log(packet.data);
                    if (packet.data.status.device === null) {
                        $("[data-indicator='device']").text("(no midi)");
                    }
                    else {
                        $("[data-indicator='device']").text(packet.data.status.device);
                    }

                    if (packet.data.status.ruleset === null) {
                        $("[data-indicator='ruleset']").text("(no ruleset)");
                    }
                    else {
                        $("[data-indicator='ruleset']").text(packet.data.status.ruleset);
                    }
                }
            }
        };

        ws.onclose = function() {
            $("[data-indicator='ws']").addClass("off");
            setTimeout(function() {
                connect();
            }, 1000);
        };

        ws.onerror = function() {
            ws.close();
        };
    };

    connect();


    var animateSignal = function($el) {
        $el.on('transitionend', function() {
            $el.remove();
        });

        setTimeout(function() {
            $el.addClass("fading");
        }, 20);
    };

    var noteTimeouts = {};

    var noteOn = function(note, display, v) {
        var $note = $("[data-note='" + note + "']");

        if (noteTimeouts[note] !== null && noteTimeouts[note] !== undefined) {
            clearTimeout(noteTimeouts[note]);
            noteTimeouts[note] = null;
        }

        if ($note.length !== 0) {
            $note.removeClass("fading");
        }
        else {
            $note = $("<span class='note' data-note='" + note + "'>" + display + "</span>");

            var $insertBefore = null;
            $(".notes .note").each(function(index, element) {
                var current = parseInt($(element).attr("data-note"));
                if (current < note) {
                    return;
                }

                if (current > note && $insertBefore === null) {
                    $insertBefore = $(element);
                    return;
                }
            });

            if ($insertBefore === null) {
                $(".notes").append($note);
            }
            else {
                $note.insertBefore($insertBefore);
            }
        }

        var value = v * 2;
        $note.css("color", "rgb(" + value + ", " + value + ", " + value + ")");
        $note.css("border-color", "rgb(" + value + ", " + value + ", " + value + ")");
    };

    var noteOff = function(note) {
        $("[data-note='" + note + "']").addClass("fading");
        noteTimeouts[note] = setTimeout(function() {
            $("[data-note='" + note + "']").remove();
        }, 500);
    }


    var reflectConsoleMode = function() {
        if (consoleMode) {
            $("[data-indicator='console']").removeClass("off");
            $(".notes-canvas").removeClass("off");
        }
        else {
            $("[data-indicator='console']").addClass("off");
            $(".notes-canvas").addClass("off");
        }
    };

    // Init to default value
    reflectConsoleMode();



    // Key Events
    var sendAction = function(action) {
        action.type = 'action';

        ws.send(JSON.stringify(action));
    };

    var changeRuleSet = function(name) {
        sendAction({
            action: 'change_ruleset',
            name: name
        });
    };

    $(window).on('keyup', function(e) {
        if (e.key === "1") {
            changeRuleSet('braincramp');
        }
        else if (e.key === "2") {
            changeRuleSet('cakewalk');
        }
        else if (e.key === "3") {
            changeRuleSet(null);
        }
        else if (e.key === "4") {
            ws.send('4asdjklf');
        }
    });
});
        </script>
    </body>
</html>
